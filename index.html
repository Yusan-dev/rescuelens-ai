<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RescueLens AI - Kesiapsiagaan Bencana</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        #video-container { position: relative; width: 100%; max-width: 500px; margin: auto; border: 4px solid #3b82f6; }
        video { transform: scaleX(1); }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="gradient-bg text-white p-6 text-center shadow-lg">
        <h1 class="text-2xl font-bold uppercase tracking-wider">RESCUELENS AI</h1>
        <p class="text-sm opacity-90">Solusi Digital untuk Kesiapsiagaan Bencana</p>
    </header>

    <main class="p-4 max-w-2xl mx-auto">
        <section class="bg-white rounded-xl shadow-md p-4 mb-6 text-center">
            <h2 class="font-bold text-gray-700 mb-2">üì∏ AI Structural Scanner</h2>
            <p class="text-xs text-gray-500 mb-4 font-semibold italic">Arahkan kamera ke area terdampak (Dinding/Tanah)</p>
            
            <div id="video-container" class="rounded-lg overflow-hidden bg-black aspect-video flex items-center justify-center">
                <video id="webcam" autoplay playsinline muted class="w-full h-full object-cover"></video>
            </div>
            
            <div id="status-box" class="mt-4 p-3 rounded-lg bg-gray-50 border border-gray-200">
                <p id="prediction-text" class="font-bold text-lg text-blue-700 italic">MENGINISIALISASI AI...</p>
                <p id="confidence-text" class="text-xs text-gray-600">Menyiapkan sensor kamera...</p>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow-md p-4">
            <h2 class="font-bold text-gray-700 mb-4">üí¨ Asisten Darurat (Chatbot)</h2>
            <div id="chat-box" class="h-48 overflow-y-auto border rounded-lg mb-4 p-3 text-sm bg-gray-50 flex flex-col gap-2">
                <div class="bg-blue-100 p-2 rounded-lg self-start max-w-[80%] text-blue-800">
                    <strong>AI:</strong> Halo! Apa kondisi darurat yang Anda alami? (Ketik: Gempa, Banjir, atau Luka)
                </div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="user-input" placeholder="Tulis pesan..." class="flex-1 border p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="askAI()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">KIRIM</button>
            </div>
        </section>
    </main>

    <script>
        let model;
        const video = document.getElementById('webcam');
        const predictionText = document.getElementById('prediction-text');
        const confidenceText = document.getElementById('confidence-text');

        // 1. Inisialisasi Model & Kamera
        async function init() {
            try {
                predictionText.innerText = "MEMUAT MODEL AI...";
                model = await mobilenet.load();
                predictionText.innerText = "MODEL SIAP!";
                
                startCamera();
            } catch (error) {
                console.error(error);
                predictionText.innerText = "GAGAL MEMUAT MODEL.";
            }
        }

        // 2. Fungsi Kamera Lebih Stabil
        async function startCamera() {
            const constraints = {
                video: {
                    facingMode: "environment", // Kamera belakang
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    predictionText.innerText = "MENGANALISIS...";
                    predictLoop();
                };
            } catch (err) {
                console.error("Kamera Error: ", err);
                predictionText.innerText = "IZINKAN KAMERA!";
                confidenceText.innerText = "Klik ikon gembok di browser untuk memberi izin.";
            }
        }

        // 3. Deteksi Objek/Bahaya
        async function predictLoop() {
            if (model) {
                const predictions = await model.classify(video);
                
                if (predictions.length > 0) {
                    const topResult = predictions[0].className.toLowerCase();
                    const score = predictions[0].probability;

                    // Logika Analisis Bahaya
                    const dangerKeywords = ['crack', 'wall', 'rubble', 'ruin', 'dirt', 'mud', 'rock'];
                    const isDanger = dangerKeywords.some(keyword => topResult.includes(keyword));

                    if (isDanger && score > 0.2) {
                        predictionText.innerText = "‚ö†Ô∏è WASPADA: RISIKO STRUKTUR";
                        predictionText.className = "font-bold text-lg text-red-600";
                    } else {
                        predictionText.innerText = "KONDISI TERPANTAU NORMAL";
                        predictionText.className = "font-bold text-lg text-green-600";
                    }
                    
                    confidenceText.innerText = `Terdeteksi: ${topResult} (${(score * 100).toFixed(1)}%)`;
                }
            }
            requestAnimationFrame(predictLoop);
        }

        // 4. Chatbot Logic
        function askAI() {
            const inputField = document.getElementById('user-input');
            const input = inputField.value.trim().toLowerCase();
            const chatBox = document.getElementById('chat-box');
            if (!input) return;

            let response = "Maaf, tetap tenang dan hubungi 112. Coba tanya: 'Gempa', 'Banjir', atau 'Patah Tulang'.";

            if (input.includes("gempa")) {
                response = "Gunakan metode DROP (Berlutut), COVER (Lindungi kepala), HOLD ON (Berpegangan). Jauhi kaca.";
            } else if (input.includes("luka") || input.includes("patah") || input.includes("darah")) {
                response = "Jangan pindahkan korban kecuali dalam bahaya. Tekan luka luar untuk hentikan darah.";
            } else if (input.includes("banjir")) {
                response = "Matikan aliran listrik segera. Amankan dokumen penting dan evakuasi ke tempat tinggi.";
            } else if (input.includes("kebakaran")) {
                response = "Merangkaklah di bawah asap. Gunakan kain basah untuk menutup hidung dan mulut.";
            }

            // Tampilkan chat
            chatBox.innerHTML += `<div class="bg-gray-200 p-2 rounded-lg self-end max-w-[80%] text-gray-800 font-semibold">${input}</div>`;
            chatBox.innerHTML += `<div class="bg-blue-100 p-2 rounded-lg self-start max-w-[80%] text-blue-800"><strong>AI:</strong> ${response}</div>`;
            
            inputField.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Jalankan inisialisasi
        init();
    </script>
</body>
</html>
